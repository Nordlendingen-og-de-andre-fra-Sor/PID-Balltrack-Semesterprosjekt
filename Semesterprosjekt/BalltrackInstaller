#!/usr/bin/env bash
set -euo pipefail

# ============================================================
# BalltrackInstaller
# ------------------------------------------------------------
# ÉNGANGS installasjon:
#  - Installerer OS-pakker (apt)
#  - Klargjør Python-miljø
#  - Lager desktop-ikon
#
# Husk: chmod +x BalltrackInstaller
# Kjør med: ./BalltrackInstaller
#
# Etter dette brukes KUN:
#   ./Balltrack
# ============================================================

PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
APP_NAME="Balltrack"
DESKTOP_DIR="$HOME/Desktop"
DESKTOP_FILE="$DESKTOP_DIR/Balltrack.desktop"

echo
echo "======================================"
echo "  Balltrack – Installer"
echo "======================================"
echo "Prosjektmappe:"
echo "  $PROJECT_DIR"
echo

# ------------------------------------------------------------
# 1) Sjekk OS
# ------------------------------------------------------------
echo "[1/6] Sjekker system..."
uname -a
echo

# ------------------------------------------------------------
# 2) Installer OS-avhengigheter
# ------------------------------------------------------------
echo "[2/6] Installerer systempakker (apt)"
sudo apt-get update
sudo apt-get install -y \
  python3 \
  python3-pip \
  python3-venv \
  python3-tk \
  python3-matplotlib \
  python3-numpy \
  i2c-tools

echo "✓ Systempakker installert"
echo

# ------------------------------------------------------------
# 3) Sørg for at launcher er kjørbar
# ------------------------------------------------------------
echo "[3/6] Klargjør launcher"
chmod +x "$PROJECT_DIR/Balltrack"
echo "✓ Balltrack launcher er kjørbar"
echo

# ------------------------------------------------------------
# 4) Desktop-ikon
# ------------------------------------------------------------
echo "[4/6] Lager desktop-ikon"

mkdir -p "$DESKTOP_DIR"

cat > "$DESKTOP_FILE" <<EOF
[Desktop Entry]
Type=Application
Name=Balltrack
Comment=Balltrack reguleringssystem (V8)
Exec=$PROJECT_DIR/Balltrack
Path=$PROJECT_DIR
Terminal=false
Categories=Education;Science;
EOF

chmod +x "$DESKTOP_FILE"

echo "✓ Desktop-ikon opprettet:"
echo "  $DESKTOP_FILE"
echo

# ------------------------------------------------------------
# 5) Første sjekk av miljø (uten GUI-start)
# ------------------------------------------------------------
echo "[5/6] Tester miljø (venv + imports)"
"$PROJECT_DIR/Balltrack" --check || true
echo

# ------------------------------------------------------------
# 6) Ferdig
# ------------------------------------------------------------
echo "[6/6] FERDIG"
echo
echo "======================================"
echo " Balltrack er installert"
echo
echo "Start programmet ved å:"
echo "  • klikke på Balltrack-ikonet på skrivebordet"
echo "  • eller kjøre: ./Balltrack"
echo "======================================"
echo
